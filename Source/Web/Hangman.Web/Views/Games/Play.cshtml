@model Hangman.Web.ViewModels.Games.NewGameViewModel
@{
    ViewBag.Title = "Play";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var numberOfLetters = Model.OpenedPositions.Count();
    var initialImageUrl = "/Content/images/hangman/" + Model.NumberOfErrors + ".png";
}

<h2>Play</h2>

<div id="hangman-image">
    <img src="@initialImageUrl" alt="No Image" />
</div>

<div id="wordContainer">
    @for (int i = 0; i < numberOfLetters; i++)
    {
        var letter = Model.OpenedPositions[i];

        if (letter == '\0')
        {
            <span class="hiddenLetter letter" data-index="@i">_</span>
        }
        else if (letter != '*')
        {
            <span class="letter">@letter</span>
        }
        else
        {
            <span class="letter">&nbsp;</span>
        }
    }
</div>

<button id="btnGuess" class="btn btn-primary">Guess</button>

@if (Model.IsMultiplayer)
{
    <div>
        <h2 class="waitingForOpponent">Waiting for opponent</h2>

    </div>
}

@section Scripts {
    <script src="~/signalr/hubs"></script>
    <script>

        $(function () {
            // Reference the auto-generated proxy for the hub.
            var chat = $.connection.notifier;
            // Create a function that the hub can call back to display messages.
            chat.client.updateGame = function updateGame() {
                updateGameValues();
            }

            // Start the connection.
            $.connection.hub.start().done(function () {
                //$('#btnJoinGame').click(function () {
                //    // Call the joinGame method on the hub.
                //    chat.server.joinGame($(this).attr('data-gameId'));
                //});
            });
        });

        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }

        $('#wordContainer').on('click', '.hiddenLetter', function () {
            var $this = $(this);

            if ($('#wordContainer').find('input').length != 0) {
                return;
            }

            renderInputLetter($this);
        });

        function updateGameValues() {
            $.ajax({
                url: '/games/GetCurrentStatus',
                data: {gameId: '@Model.GameId'},
                success: function(data) {
                    debugger;
                }
            });
        }

        function renderInputLetter(container) {
            container.empty();
            var $input = $('<input type="text" pattern="[A-Za-z]{1}">');
            $input.attr('maxlength', 1);
            $input.addClass('letterInput letter');
            container.append($input);
            $input.focus();
        }

        $('#btnGuess').on('click', function () {
            var allHiddenLettersContainers = $('.hiddenLetter');
            var guessLetters = allHiddenLettersContainers.find('input');
            var guesses = [];
            for (var i = 0; i < guessLetters.length; i++) {
                var currentGuess = guessLetters[i].value;
                if (currentGuess != '') {
                    guesses.push({ index: $(guessLetters[i]).parent().attr('data-index'), letter: $(guessLetters[i]).val() });
                }
            }

            if (guesses.length == 0) {
                return;
            }

            $.ajax({
                url: '/games/makeGuess',
                method: 'post',
                data: { guesses: guesses },
                success: function (data) {
                    //updateImage(data.updatedPlayer.NumberOfErrors);
                    updateWordContainer(data.updatedPlayer.OpenedPositions);
                    updateGameState(data);
                }
            });
        });

        function updateWordContainer(positions) {
            var $wordContainer = $('#wordContainer');
            $wordContainer.empty();
            for (var i = 0, length = positions.length; i < length; i += 1) {
                var currentLetter = positions[i];
                if (!currentLetter) {
                    var $hidden = $('<span>');
                    $hidden.attr('data-index', i);
                    $hidden.html(' _ ');
                    $hidden.addClass('hiddenLetter letter');
                    $wordContainer.append($hidden);
                } else if (currentLetter != '*') {
                    var $letter = $('<span>');
                    $letter.html(currentLetter);
                    $letter.addClass('letter');
                    $wordContainer.append($letter);
                } else {
                    var $space = $('<span>');
                    $space.html('&nbsp;');
                    $space.addClass('letter');
                    $wordContainer.append($space);
                }
            }
        }

        function updateGameState(data) {
            var imageFleName;
            if (data.winnerId) {
                if (data.winnerId == '@User.Identity.GetUserId()') {
                    imageFleName = 'win';
                } else {
                    imageFleName = 'loose';
                }

                setGameStateToInactive();
            } else {
                imageFleName = data.updatedPlayer.NumberOfErrors;

                if (data.updatedPlayer.NumberOfErrors == 5) {
                    imageFleName = 'loose';
                    setGameStateToInactive();
                }
            }

            updateImage(imageFleName);
        }

        function setGameStateToInactive() {
            $('#btnGuess').prop('disabled', true);
        }

        function getHidden() {
            var $hidden = $('<span>');
        }

        function updateImage(imageName) {
            $('#hangman-image img').attr('src', getImageUrl(imageName));
        }

        function getImageUrl(imageName) {
            return "/Content/images/hangman/" + imageName + ".png";
        }
    </script>
}
